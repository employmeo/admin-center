<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org"
	layout:decorator="layouts/index-layout">
<head lang="en">
<title th:text="${modelDisplay} "></title>
</head>
<body>
	<div layout:fragment="content">
			<div th:if="${item.stripeId == null}">
				<div class="x_panel">
					<div class="x_title">
					    <h3 class="text-danger">Stripe Not Connected</h3>
	        	    	<div class="clearfix"></div>
					</div>
					<div class="x_content">
						<form method='post' class="form form-horizontal" th:action="${'/admin/account/' + item.id + '/stripe'}">
							<div class="form-control-group col-xs-12 text-center">
								<span class="text-info" th:text="${'To connect ' + item.accountName + ' to stripe, select user and click Connect'}"></span>
							</div>
							<label class="control-label col-xs-12 col-sm-3">Select (Billing) User:</label>
							<div class="col-xs-12 col-sm-9"><select class="form-control" name="userId">
								<option th:each="user : ${users}" th:text="${user.email}" th:value="${user.id}"></option>
							</select></div>
							<div class="form-control-group col-xs-12 text-center">
								<hr/>
								<button type="submit" class='btn btn-primary'>Connect</button>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div th:unless="${item.stripeId == null}">
				<script src="https://js.stripe.com/v3/"></script>
				<script th:inline="javascript">
					var apikey = /*[[${stripePK}]]*/ 'pk_test_invalidkey';
					var stripe = Stripe(apikey);
				</script> 
				<div class="col-xs-12 col-sm-12">
					<div class="x_panel">
						<div class="x_title">
						    <h3 class="text-primary">Stripe Settings<a class="collapse-link pull-right small"><i class="fa fa-chevron-down"></i></a></h3>
							<h5 class="text-success">Account Connected - <a target='blank' th:text="${'View ' + item.accountName + ' in Stripe'}" th:href="${dashlink + 'customers/' + customer.id}">View in Stripe</a></h5>
		        	    	<div class="clearfix"></div>
						</div>
						<div class="x_content" style="display:none;"><pre th:text="${customer}"></pre></div>
					</div>
				</div>
				<div class="col-xs-12 col-sm-12">
					<div class="x_panel">
						<div class="x_title">
						    <h3>Invoices</h3>
	            			<div class="clearfix"></div>
						</div>
						<div class="x_content">
							<div th:if="${#lists.isEmpty(invoices) and !upcomingInvoice}"></div>
							<div th:unless="${#lists.isEmpty(invoices) and !upcomingInvoice}">
								<h2>Invoices</h2>
								<table id='invoicelist' class="table table-striped table-condensed">
								  <thead>
									<tr>
										<th>Date</th>
										<th>Period</th>
										<th>Total</th>
										<th>Amount Due</th>
										<th>Paid</th>
									</tr>
									</thead>
									<tbody>
										<tr th:each="invoice : ${invoices}">
											<td><a target="blank" th:text="${#dates.format(new java.util.Date(1000*invoice.date),'MMM dd, YYYY')}" th:href="${dashlink + 'invoices/' + invoice.id}"></a></td>
											<td th:text="${#dates.format(new java.util.Date(1000*invoice.periodStart),'MMM dd')} + ' to ' + ${#dates.format(new java.util.Date(1000*invoice.periodEnd),'MMM dd')}">Amount</td>
											<td th:text="'$ ' + ${invoice.total/100}">Total</td>
											<td th:text="'$ ' + ${invoice.amountDue/100}">Amount</td>
											<td><i th:if="${invoice.closed}" class="fa fa-thumbs-up"></i><i th:unless="${invoice.closed}" class="fa fa-thumbs-down"></i></td>
										</tr>
										<tr th:if="${upcomingInvoice}">
											<td><a target="blank" th:text="'UPCOMING: '+ ${#dates.format(new java.util.Date(1000*upcomingInvoice.date),'MMM dd, YYYY')}" th:href="${dashlink + 'customers/' + customer.id + '/upcoming_invoice'}"></a></td>
											<td th:text="${#dates.format(new java.util.Date(1000*upcomingInvoice.periodStart),'MMM dd')} + ' to ' + ${#dates.format(new java.util.Date(1000*upcomingInvoice.periodEnd),'MMM dd')}">Amount</td>
											<td th:text="'$ ' + ${upcomingInvoice.total/100}">Total</td>
											<td th:text="'$ ' + ${upcomingInvoice.amountDue/100}">Amount</td>
											<td><form th:action="${'/admin/account/' + item.id + '/previewinvoice'}" method='POST'>
												<button class='btn btn-primary btn-xs'>Preview</button></form></td>
										</tr>
									</tbody>
								</table>
								<div class="hidden"><pre th:if="${upcomingInvoice}" th:text="${upcomingInvoice}"></pre><pre th:each="invoice : ${invoices}" th:text="${invoice}"></pre></div>
							</div>
						</div>
					</div>
				</div>						
				<div class="col-xs-12 col-sm-6">
					<div class="x_panel">
						<div class="x_title">
						    <h3>Payment Info</h3>
	            			<div class="clearfix"></div>
						</div>
						<div class="x_content text-center" th:if="${customer.sources.totalCount == 0}">
						<h2 class="text-danger">Account Has No Credit Card on File</h2>
							<form th:action="${'/admin/account/' + item.id + '/addcard'}"  method="POST">
							  	<script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
							    	th:attr="data-key=${stripePK},data-email=${customer.email}"
								    data-name="Talytica"
								    data-zip-code="true"
								    data-label="Add Credit Card"
								    data-panel-label="Save Payment Info"
								    data-allow-remember-me="false"
								    data-image="/images/favicon-32x32.png"
								    data-locale="auto">
								</script>
							</form>
						</div>
						<div class="x_content" th:unless="${customer.sources.totalCount == 0}">
						<table id='cardslist' class="table table-striped table-condensed">
							  <thead>
								<tr>
									<th>Type</th>
									<th>Expiration</th>
								</tr>
								</thead>
								<tbody>
									<tr th:each="source : ${customer.sources.data}" th:if="${source.type} == 'card'">
										<td th:text="${source.typeData.brand}"></td>
										<td th:text="${source.typeData.exp_month} + '/' + ${source.typeData.exp_year}">Expiration</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="col-xs-12 col-sm-6">
					<div class="x_panel">
						<div class="x_title">
						    <h3>Subscriptions</h3>
	            			<div class="clearfix"></div>
						</div>
						<div class="x_content" th:unless="${#lists.isEmpty(plans)}">
						<span>Account is subscribed to below plans</span>
							<table id='planlist' class="table table-striped table-condensed">
							  <thead>
								<tr>
									<th>Plan</th>
									<th>Name</th>
									<th>Amount</th>
								</tr>
								</thead>
								<tbody>
									<tr th:each="plan : ${plans}">
										<td><a target="blank" th:text="${plan.id}" th:href="${dashlink + 'plans/' + plan.id}"></a></td>
										<td th:text="${plan.name}">Desc</td>
										<td th:text="${plan.amount}">Amt</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="x_content text-center" th:if="${#lists.isEmpty(plans)}">
						<h2 class="text-danger text-center">Account has no associated Plan</h2>
						<span class="text-primary">Please choose a plan to create a subscription</span>
						<form th:action="${'/admin/account/' + item.id + '/subscribe'}"  method="POST">
							<table id='planlist' class="table table-striped table-condensed text-left">
							  <thead>
								<tr>
									<th>Select</th>
									<th>Plan</th>
									<th>Name</th>
									<th>Amount</th>
								</tr>
								</thead>
								<tbody>
									<tr th:each="plan : ${allplans}">
										<td><input type="radio" name="planId" th:value="${plan.id}" required="true"></input></td>
										<td><a target="blank" th:text="${plan.id}" th:href="${dashlink + 'plans/' + plan.id}"></a></td>
										<td th:text="${plan.name}">Desc</td>
										<td th:text="${plan.amount}">Amt</td>
									</tr>
								</tbody>							
							</table>
							<button class='btn btn-default' type="submit" >Subscribe</button>
						</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>